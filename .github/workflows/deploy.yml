name: Build, Deploy to Azure VM

on:
  push:
    branches:
      - main

env:
  AZURE_VM_HOST: ${{ secrets.AZURE_VM_HOST }}
  AZURE_VM_USERNAME: ${{ secrets.AZURE_VM_USERNAME }}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      # 4. Setup SSH key
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/azure_key
          chmod 600 ~/.ssh/azure_key
          ssh-keyscan -H ${{ env.AZURE_VM_HOST }} >> ~/.ssh/known_hosts

      # 6. Copy files to Azure VM
      - name: Copy files to VM
        run: |
          # Create deployment directory on VM
          ssh -i ~/.ssh/azure_key ${{ env.AZURE_VM_USERNAME }}@${{ env.AZURE_VM_HOST }} "mkdir -p ~/app"
          
          # Copy all project files
          scp -i ~/.ssh/azure_key -r \
            docker-compose.yml \
            PanierService \
            ProductService \
            Frontend \
            ${{ env.AZURE_VM_USERNAME }}@${{ env.AZURE_VM_HOST }}:~/app/

      # 7. Deploy on Azure VM
      - name: Deploy Application
        run: |
          ssh -i ~/.ssh/azure_key ${{ env.AZURE_VM_USERNAME }}@${{ env.AZURE_VM_HOST }} << 'EOF'
            cd ~/app
            
            # Stop existing containers
            sudo docker compose down || true
            
            # Remove old images to save space
            sudo docker image prune -af || true
            
            # Build and start services
            sudo docker compose up -d --build
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 240
            
            # Check container status
            sudo docker compose ps
            
            # Check if frontend is accessible
            curl -f http://localhost:5000 || echo "Warning: Frontend not responding yet"
          EOF

      # 8. Verify Deployment
      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/azure_key ${{ env.AZURE_VM_USERNAME }}@${{ env.AZURE_VM_HOST }} << 'EOF'
            cd ~/app
            
            echo "=== Container Status ==="
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo -e "\n=== Service Health Check ==="
            sudo docker compose ps
            
            echo -e "\n=== Disk Usage ==="
            df -h /
            
            echo -e "\n=== Recent Logs ==="
            sudo docker compose logs --tail=50
          EOF

      # 9. Cleanup SSH key
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/azure_key